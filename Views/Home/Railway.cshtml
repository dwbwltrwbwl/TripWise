@{
    ViewData["Title"] = "ЖД билеты";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 2.5rem; color: #333; color: #0379D9;">
                Поиск ЖД билетов
            </h1>
            <p class="lead">Найдите билеты на поезда по России и СНГ</p>

            <!-- Форма поиска ЖД билетов -->
            <div class="card shadow-sm border-0" style="margin-top: 0;">
                <div class="card-body p-4">
                    <form id="railwaySearchForm">
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Откуда</label>
                                <div class="input-group station-autocomplete">
                                    <span class="input-group-text"><i class="fas fa-train"></i></span>
                                    <input type="text"
                                           class="form-control"
                                           id="railwayDeparture"
                                           placeholder="Станция отправления"
                                           required
                                           autocomplete="off">
                                    <div class="autocomplete-dropdown" id="departureDropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium">Куда</label>
                                <div class="input-group station-autocomplete">
                                    <span class="input-group-text"><i class="fas fa-train"></i></span>
                                    <input type="text"
                                           class="form-control"
                                           id="railwayArrival"
                                           placeholder="Станция назначения"
                                           required
                                           autocomplete="off">
                                    <div class="autocomplete-dropdown" id="arrivalDropdown"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-medium">Туда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="railwayDepartureDate" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-medium">Обратно</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="railwayReturnDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium">Пассажиры</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" id="railwayPassengers">
                                        <option value="1">1 пассажир</option>
                                        <option value="2" selected>2 пассажира</option>
                                        <option value="3">3 пассажира</option>
                                        <option value="4">4 пассажира</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100 text-center" style="height: 46px;">
                                    <i class="fas fa-search me-2"></i>Найти
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Контейнер для результатов -->
            <div id="railwayResults" class="mt-4"></div>

            <!-- Индикатор загрузки -->
            <div id="railwayLoading" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Ищем доступные поезда...</p>
            </div>

            <!-- Популярные направления -->
            <div class="mt-5">
                <h3 class="mb-4">Популярные направления</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://avatars.dzeninfra.ru/get-zen_doc/8302711/pub_6466413b3c24f951449f3665_646643977733f348e0d5d55d/scale_1200" class="card-img-top" alt="Москва - Нижний Новгород">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Нижний Новгород</h5>
                                <p class="card-text">От 1 500 ₽</p>
                                <p class="text-muted small">В пути от 4 часов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://don-plaza.ru/upload/iblock/61d/lvb77ryhs40dxr00pgdr9d3l559cl01s.jpg" class="card-img-top" alt="Москва - Ростов-на-Дону">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Ростов-на-Дону</h5>
                                <p class="card-text">От 2 300 ₽</p>
                                <p class="text-muted small">В пути от 15 часов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://mf.b37mrtl.ru/rbthmedia/images/2024.01/original/65ae71e1154af9591d0b3b5c.jpg" class="card-img-top" alt="Москва - Самара">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Самара</h5>
                                <p class="card-text">От 2 100 ₽</p>
                                <p class="text-muted small">В пути от 14 часов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://cdn.culture.ru/images/e767157a-5487-52de-9eab-8ec54a97f505" class="card-img-top" alt="Москва - Уфа">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Уфа</h5>
                                <p class="card-text">От 2 600 ₽</p>
                                <p class="text-muted small">В пути от 20 часов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://i.pinimg.com/736x/be/0f/30/be0f308009ab84acc7a35059fc49d4ff.jpg" class="card-img-top" alt="Москва - Красноярск">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Красноярск</h5>
                                <p class="card-text">От 4 500 ₽</p>
                                <p class="text-muted small">В пути от 56 часов</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://cache3.youla.io/files/images/720_720_out/5c/b7/5cb7a549f094f3374a714302.jpg" class="card-img-top" alt="Москва - Воронеж">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Воронеж</h5>
                                <p class="card-text">От 1 400 ₽</p>
                                <p class="text-muted small">В пути от 8 часов</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .station-autocomplete {
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

    .station-name {
        font-weight: 600;
        color: #333;
    }

    .station-region {
        font-size: 0.85em;
        color: #666;
    }

    .train-card {
        transition: transform 0.2s ease;
        border: 1px solid #e9ecef;
    }

        .train-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

    .train-number {
        font-size: 0.9em;
        color: #666;
    }

    .train-name {
        font-weight: 600;
        color: #333;
    }

    .train-time {
        font-size: 1.2em;
        font-weight: 700;
        color: #333;
    }

    .train-duration {
        font-size: 0.9em;
        color: #666;
    }

    .train-price {
        font-size: 1.3em;
        font-weight: 700;
    }

    .route-line {
        color: #ddd;
        font-size: 0.8em;
    }

    .carrier {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
    }

    .destination-card {
        transition: transform 0.2s ease;
    }

        .destination-card:hover {
            transform: translateY(-5px);
        }

        .destination-card img {
            height: 200px;
            object-fit: cover;
        }
</style>

@section Scripts {
    <script>
        const YANDEX_API_KEY = 'b9d46706-196e-4002-846d-36f4c8062d9a';
        const YANDEX_API_BASE = 'https://api.rasp.yandex.net/v3.0';

        let stationsCache = new Map();

        document.addEventListener('DOMContentLoaded', function() {
            setupAutocomplete();
            // Тестируем API сразу при загрузке
            testYandexAPI();
        });

        function setupAutocomplete() {
            const departureInput = document.getElementById('railwayDeparture');
            const arrivalInput = document.getElementById('railwayArrival');
            const departureDropdown = document.getElementById('departureDropdown');
            const arrivalDropdown = document.getElementById('arrivalDropdown');

            setupInputAutocomplete(departureInput, departureDropdown);
            setupInputAutocomplete(arrivalInput, arrivalDropdown);
        }

        function setupInputAutocomplete(input, dropdown) {
            let timeoutId;

            input.addEventListener('input', function(e) {
                clearTimeout(timeoutId);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    dropdown.style.display = 'none';
                    return;
                }

                timeoutId = setTimeout(() => {
                    searchStations(query, dropdown);
                }, 400);
            });

            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        async function searchStations(query, dropdown) {
            const cacheKey = query.toLowerCase();

            if (stationsCache.has(cacheKey)) {
                displayStations(stationsCache.get(cacheKey), dropdown);
                return;
            }

            showAutocompleteLoading(dropdown, true);

            try {
                const stations = await fetchStationsFromYandex(query);

                if (stations.length > 0) {
                    stationsCache.set(cacheKey, stations);
                    displayStations(stations, dropdown);
                } else {
                    showAutocompleteError(dropdown, 'Станции не найдены');
                }

            } catch (error) {
                console.error('Ошибка поиска станций:', error);
                showAutocompleteError(dropdown, 'Ошибка подключения к Яндекс API: ' + error.message);
            } finally {
                showAutocompleteLoading(dropdown, false);
            }
        }

        async function fetchStationsFromYandex(query) {
            try {
                // Прямой запрос к Яндекс API
                const url = `${YANDEX_API_BASE}/stations_list/?apikey=${YANDEX_API_KEY}&format=json&lang=ru_RU&station=${encodeURIComponent(query)}`;

                console.log('🔍 Запрос к Яндекс API:', url);

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                console.log('📊 Статус ответа:', response.status, response.statusText);

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ Данные от Яндекс API:', data);
                    return parseYandexStationsData(data);
                } else {
                    const errorText = await response.text();
                    console.error('❌ Ошибка API:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('❌ Ошибка запроса:', error);
                throw error;
            }
        }

        function parseYandexStationsData(data) {
            const stations = [];

            if (!data || !data.countries) {
                console.log('📭 Нет данных countries в ответе');
                return stations;
            }

            console.log('🌍 Структура ответа:', data);

            data.countries.forEach(country => {
                if (country.regions) {
                    country.regions.forEach(region => {
                        if (region.settlements) {
                            region.settlements.forEach(settlement => {
                                if (settlement.stations) {
                                    settlement.stations.forEach(station => {
                                        if (station.codes && station.codes.yandex_code) {
                                            stations.push({
                                                name: station.title || 'Неизвестно',
                                                code: station.codes.yandex_code,
                                                city: settlement.title || 'Неизвестно',
                                                region: region.title || 'Неизвестно',
                                                fullName: `${station.title} (${settlement.title})`
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });

            console.log(`🎯 Найдено станций: ${stations.length}`);
            return stations.slice(0, 15);
        }

        function showAutocompleteLoading(dropdown, show) {
            if (show) {
                dropdown.innerHTML = '<div class="autocomplete-item text-muted"><div class="spinner-border spinner-border-sm me-2"></div>Ищем станции в Яндекс API...</div>';
                dropdown.style.display = 'block';
            }
        }

        function showAutocompleteError(dropdown, message) {
            dropdown.innerHTML = `<div class="autocomplete-item text-danger"><i class="fas fa-exclamation-triangle me-2"></i>${message}</div>`;
            dropdown.style.display = 'block';
        }

        function displayStations(stations, dropdown) {
            dropdown.innerHTML = '';

            if (!stations || stations.length === 0) {
                showAutocompleteError(dropdown, 'Станции не найдены');
                return;
            }

            stations.forEach(station => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';
                item.innerHTML = `
                    <div class="station-name">${escapeHtml(station.name)}</div>
                    <div class="station-region">${escapeHtml(station.city)}${station.region && station.region !== 'Неизвестно' ? ', ' + escapeHtml(station.region) : ''}</div>
                `;

                item.addEventListener('click', function() {
                    const input = dropdown.previousElementSibling;
                    input.value = station.fullName;
                    input.setAttribute('data-station-code', station.code);
                    dropdown.style.display = 'none';

                    console.log('📍 Выбрана станция:', station);
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Функция для тестирования API
        async function testYandexAPI() {
            console.log('🧪 Начинаем тестирование Яндекс API...');

            const testQueries = ['Москва', 'Санкт-Петербург', 'Казань'];

            for (const query of testQueries) {
                try {
                    console.log(`\n🔍 Тестируем запрос: "${query}"`);
                    const stations = await fetchStationsFromYandex(query);
                    console.log(`✅ Для "${query}" найдено: ${stations.length} станций`);

                    if (stations.length > 0) {
                        console.log('Примеры станций:', stations.slice(0, 2));
                    }
                } catch (error) {
                    console.error(`❌ Ошибка для "${query}":`, error.message);
                }

                // Пауза между запросами
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            console.log('🏁 Тестирование завершено');
        }
    </script>
}