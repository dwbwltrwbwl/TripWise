@{
    ViewData["Title"] = "ЖД билеты";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 2.5rem; color: #333; color: #0379D9;">
                Поиск ЖД билетов
            </h1>
            <p class="lead">Найдите билеты на поезда по России и СНГ</p>

            <!-- Форма поиска ЖД билетов -->
            <div class="card shadow-sm border-0" style="margin-top: 0;">
                <div class="card-body p-4">
                    <form id="railwaySearchForm">
                        <!-- Первая строка -->
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Откуда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-train"></i></span>
                                    <input type="text"
                                           class="form-control"
                                           id="railwayDeparture"
                                           placeholder="Станция отправления"
                                           required
                                           style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Куда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-train"></i></span>
                                    <input type="text"
                                           class="form-control"
                                           id="railwayArrival"
                                           placeholder="Станция назначения"
                                           required
                                           style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                        </div>

                        <!-- Вторая строка -->
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Туда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="railwayDepartureDate" required style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Обратно</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="railwayReturnDate" style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Пассажиры</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" id="railwayPassengers" style="font-family: 'Nunito', sans-serif;">
                                        <option value="1">1 пассажир</option>
                                        <option value="2" selected>2 пассажира</option>
                                        <option value="3">3 пассажира</option>
                                        <option value="4">4 пассажира</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100 text-center" style="font-family: 'Nunito', sans-serif; height: 46px;">
                                    <i class="fas fa-search me-2"></i>Найти
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Популярные направления -->
            <div class="mt-5">
                <h3 class="mb-4">Популярные направления</h3>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://avatars.dzeninfra.ru/get-zen_doc/8302711/pub_6466413b3c24f951449f3665_646643977733f348e0d5d55d/scale_1200" class="card-img-top" alt="Москва - Нижний Новгород">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Нижний Новгород</h5>
                                    <p class="card-text">От 1 500 ₽</p>
                                    <p class="text-muted small">В пути от 4 часов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://don-plaza.ru/upload/iblock/61d/lvb77ryhs40dxr00pgdr9d3l559cl01s.jpg" class="card-img-top" alt="Москва - Ростов-на-Дону">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Ростов-на-Дону</h5>
                                    <p class="card-text">От 2 300 ₽</p>
                                    <p class="text-muted small">В пути от 15 часов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://mf.b37mrtl.ru/rbthmedia/images/2024.01/original/65ae71e1154af9591d0b3b5c.jpg" class="card-img-top" alt="Москва - Самара">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Самара</h5>
                                    <p class="card-text">От 2 100 ₽</p>
                                    <p class="text-muted small">В пути от 14 часов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://cdn.culture.ru/images/e767157a-5487-52de-9eab-8ec54a97f505" class="card-img-top" alt="Москва - Уфа">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Уфа</h5>
                                    <p class="card-text">От 2 600 ₽</p>
                                    <p class="text-muted small">В пути от 20 часов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://i.pinimg.com/736x/be/0f/30/be0f308009ab84acc7a35059fc49d4ff.jpg" class="card-img-top" alt="Москва - Красноярск">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Красноярск</h5>
                                    <p class="card-text">От 4 500 ₽</p>
                                    <p class="text-muted small">В пути от 56 часов</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card destination-card h-100">
                                <img src="https://cache3.youla.io/files/images/720_720_out/5c/b7/5cb7a549f094f3374a714302.jpg" class="card-img-top" alt="Москва - Воронеж">
                                <div class="card-body">
                                    <h5 class="card-title">Москва → Воронеж</h5>
                                    <p class="card-text">От 1 400 ₽</p>
                                    <p class="text-muted small">В пути от 8 часов</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    <script>
        let currentDropdown = null;
        let currentInput = null;
        let timeoutId;

        // Функция для поиска ЖД станций через API РЖД
        async function searchRailwayStations(query, dropdown) {
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }

            try {
                // API РЖД для автозаполнения станций
                const url = `https://api.rasp.yandex.net/v3.0/stations_list/?apikey=YOUR_API_KEY&format=json&lang=ru_RU&field=settlements&term=${encodeURIComponent(query)}`;

                // Временное решение - используем статичный список популярных станций
                // На практике нужно получить API ключ от Яндекс.Расписаний
                const stations = getPopularStations(query);
                showAutocompleteResults(stations, dropdown, query);

            } catch (error) {
                console.error('Ошибка при поиске станций:', error);
                dropdown.style.display = 'none';
            }
        }

        // Статичный список популярных ЖД станций
        function getPopularStations(query) {
            const allStations = [
                { name: 'Москва (Ярославский вокзал)', city: 'Москва', code: '2000000', type: 'station' },
                { name: 'Москва (Казанский вокзал)', city: 'Москва', code: '2000001', type: 'station' },
                { name: 'Москва (Курский вокзал)', city: 'Москва', code: '2000002', type: 'station' },
                { name: 'Москва (Ленинградский вокзал)', city: 'Москва', code: '2000003', type: 'station' },
                { name: 'Санкт-Петербург (Главный)', city: 'Санкт-Петербург', code: '2004000', type: 'station' },
                { name: 'Санкт-Петербург (Витебский)', city: 'Санкт-Петербург', code: '2004001', type: 'station' },
                { name: 'Екатеринбург (Главный)', city: 'Екатеринбург', code: '2030000', type: 'station' },
                { name: 'Новосибирск (Главный)', city: 'Новосибирск', code: '2044000', type: 'station' },
                { name: 'Казань (Главный)', city: 'Казань', code: '2060000', type: 'station' },
                { name: 'Нижний Новгород (Московский)', city: 'Нижний Новгород', code: '2060001', type: 'station' },
                { name: 'Краснодар (Главный)', city: 'Краснодар', code: '2064000', type: 'station' },
                { name: 'Сочи (Главный)', city: 'Сочи', code: '2064130', type: 'station' },
                { name: 'Калининград (Южный)', city: 'Калининград', code: '2058000', type: 'station' },
                { name: 'Владивосток (Главный)', city: 'Владивосток', code: '2034000', type: 'station' },
                { name: 'Самара (Главный)', city: 'Самара', code: '2024000', type: 'station' },
                { name: 'Омск (Главный)', city: 'Омск', code: '2044700', type: 'station' },
                { name: 'Челябинск (Главный)', city: 'Челябинск', code: '2040700', type: 'station' },
                { name: 'Ростов-на-Дону (Главный)', city: 'Ростов-на-Дону', code: '2064001', type: 'station' },
                { name: 'Уфа (Главный)', city: 'Уфа', code: '2024700', type: 'station' },
                { name: 'Волгоград (Главный)', city: 'Волгоград', code: '2020000', type: 'station' }
            ];

            const queryLower = query.toLowerCase();
            return allStations.filter(station =>
                station.name.toLowerCase().includes(queryLower) ||
                station.city.toLowerCase().includes(queryLower)
            ).slice(0, 8);
        }

        // Функция показа результатов автозаполнения
        function showAutocompleteResults(stations, dropdown, query) {
            dropdown.innerHTML = '';

            if (stations.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'autocomplete-item';
                noResults.textContent = 'Ничего не найдено';
                dropdown.appendChild(noResults);
                dropdown.style.display = 'block';
                return;
            }

            stations.forEach(station => {
                const item = document.createElement('div');
                item.className = 'autocomplete-item';

                const displayText = `
                    <div class="station-name">${highlightMatch(station.name, query)}</div>
                    <div class="station-city">${highlightMatch(station.city, query)}</div>
                `;

                item.innerHTML = displayText;

                item.addEventListener('click', () => {
                    currentInput.value = station.name;
                    dropdown.style.display = 'none';
                });

                dropdown.appendChild(item);
            });

            dropdown.style.display = 'block';
        }

        // Функция подсветки совпадений
        function highlightMatch(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        // Debounce для оптимизации запросов
        function debounceSearch(input, dropdown, delay = 300) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                searchRailwayStations(input.value, dropdown);
            }, delay);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const departureInput = document.getElementById('railwayDeparture');
            const arrivalInput = document.getElementById('railwayArrival');
            const departureDropdown = document.getElementById('railwayDepartureDropdown');
            const arrivalDropdown = document.getElementById('railwayArrivalDropdown');

            // Обработчики для поля "Откуда"
            departureInput.addEventListener('input', () => {
                currentDropdown = departureDropdown;
                currentInput = departureInput;
                debounceSearch(departureInput, departureDropdown);
            });

            departureInput.addEventListener('focus', () => {
                if (departureInput.value.length >= 2) {
                    currentDropdown = departureDropdown;
                    currentInput = departureInput;
                    searchRailwayStations(departureInput.value, departureDropdown);
                }
            });

            // Обработчики для поля "Куда"
            arrivalInput.addEventListener('input', () => {
                currentDropdown = arrivalDropdown;
                currentInput = arrivalInput;
                debounceSearch(arrivalInput, arrivalDropdown);
            });

            arrivalInput.addEventListener('focus', () => {
                if (arrivalInput.value.length >= 2) {
                    currentDropdown = arrivalDropdown;
                    currentInput = arrivalInput;
                    searchRailwayStations(arrivalInput.value, arrivalDropdown);
                }
            });

            // Закрытие dropdown при клике вне
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.station-autocomplete')) {
                    departureDropdown.style.display = 'none';
                    arrivalDropdown.style.display = 'none';
                }
            });

            // Навигация с клавиатуры
            document.addEventListener('keydown', (e) => {
                if (!currentDropdown || currentDropdown.style.display === 'none') return;

                const items = currentDropdown.querySelectorAll('.autocomplete-item');
                let activeItem = currentDropdown.querySelector('.autocomplete-item.active');
                let activeIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        if (activeIndex < items.length - 1) {
                            if (activeItem) activeItem.classList.remove('active');
                            items[activeIndex + 1].classList.add('active');
                        } else if (items.length > 0 && activeIndex === -1) {
                            items[0].classList.add('active');
                        }
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        if (activeIndex > 0) {
                            if (activeItem) activeItem.classList.remove('active');
                            items[activeIndex - 1].classList.add('active');
                        }
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (activeItem) {
                            activeItem.click();
                        }
                        break;
                    case 'Escape':
                        currentDropdown.style.display = 'none';
                        break;
                }
            });

            // Установка минимальной даты
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('railwayDepartureDate').min = today;
            document.getElementById('railwayReturnDate').min = today;

            // Обновление минимальной даты для обратного билета
            document.getElementById('railwayDepartureDate').addEventListener('change', function() {
                document.getElementById('railwayReturnDate').min = this.value;
            });

            // Обработка отправки формы
            document.getElementById('railwaySearchForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const departure = departureInput.value;
                const arrival = arrivalInput.value;
                const departureDate = document.getElementById('railwayDepartureDate').value;
                const returnDate = document.getElementById('railwayReturnDate').value;
                const passengers = document.getElementById('railwayPassengers').value;

                if (!departure || !arrival) {
                    alert('Пожалуйста, заполните станции отправления и назначения');
                    return;
                }

                console.log('Поиск ЖД билетов:', {
                    departure,
                    arrival,
                    departureDate,
                    returnDate,
                    passengers
                });

                alert(`Поиск ЖД билетов из ${departure} в ${arrival} на ${passengers} пассажира(ов)`);
            });
        });
    </script>
}