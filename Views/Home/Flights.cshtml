@{
    ViewData["Title"] = "Авиабилеты";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 2.5rem; color: #333; color: #0379D9;">
                Поиск авиабилетов
            </h1>
            <p class="lead">Найдите лучшие предложения на авиабилеты по всему миру</p>

            <!-- Форма поиска авиабилетов -->
            <div class="card shadow-sm border-0" style="margin-top: 0;">
                <div class="card-body p-4">
                    <form id="flightSearchForm">
                        <!-- Первая строка -->
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Откуда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-plane-departure"></i></span>
                                    <input type="text"
                                           class="form-control city-autocomplete"
                                           id="departureCity"
                                           placeholder="Город вылета"
                                           autocomplete="off"
                                           style="font-family: 'Nunito', sans-serif;">
                                    <div class="autocomplete-dropdown" id="departureDropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Куда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-plane-arrival"></i></span>
                                    <input type="text"
                                           class="form-control city-autocomplete"
                                           id="arrivalCity"
                                           placeholder="Город прилета"
                                           autocomplete="off"
                                           style="font-family: 'Nunito', sans-serif;">
                                    <div class="autocomplete-dropdown" id="arrivalDropdown"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Вторая строка -->
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Туда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="departureDate" style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Обратно</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="returnDate" style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Пассажиры</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" id="passengers" style="font-family: 'Nunito', sans-serif;">
                                        <option value="1">1 пассажир</option>
                                        <option value="2">2 пассажира</option>
                                        <option value="3">3 пассажира</option>
                                        <option value="4">4 пассажира</option>
                                    </select>
                                </div>
                            </div>
                            @* <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Класс обслуживания</label>
                                    <select class="form-select" id="class" style="font-family: 'Nunito', sans-serif;">
                                        <option value="economy">Эконом</option>
                                        <option value="business">Бизнес</option>
                                        <option value="first">Первый</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-medium">Тип поездки</label>
                                    <select class="form-select" id="tripType" style="font-family: 'Nunito', sans-serif;">
                                        <option value="round">Туда и обратно</option>
                                        <option value="oneway">В одну сторону</option>
                                    </select>
                                </div>
                            </div> *@
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100 text-center" style="font-family: 'Nunito', sans-serif; height: 46px;">
                                    <i class="fas fa-search me-2"></i>Найти
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Популярные направления -->
            <div class="mt-5">
                <h3 class="mb-4">Популярные направления</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://i.pinimg.com/originals/8e/d6/12/8ed6120ddbb569d44c6c7edaea15cce9.png" class="card-img-top" alt="Москва - Санкт-Петербург">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Санкт-Петербург</h5>
                                <p class="card-text">От 2 500 ₽</p>
                                <p class="text-muted small">В пути от 1ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://www.kupibilet.ru/blog/wp-content/uploads/2025/06/sochi-park-1.jpg" class="card-img-top" alt="Москва - Сочи">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Сочи</h5>
                                <p class="card-text">От 4 800 ₽</p>
                                <p class="text-muted small">В пути от 2ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://cdn.culture.ru/images/a95b2c46-77db-5224-a88b-1079b9f3c3b0" class="card-img-top" alt="Москва - Казань">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Казань</h5>
                                <p class="card-text">От 3 200 ₽</p>
                                <p class="text-muted small">В пути от 1ч 45м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://sdelanounas.ru/i/a/w/1/f_aW1nLmdlbGlvcGhvdG8uY29tL2VrYjIwMjAvMjhfZWtiMjAyMC5qcGc_X19pZD0xMzY3NTQ=.jpeg" class="card-img-top" alt="Москва - Екатеринбург">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Екатеринбург</h5>
                                <p class="card-text">От 3 800 ₽</p>
                                <p class="text-muted small">В пути от 2ч 15м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://blog.ostrovok.ru/wp-content/uploads/2022/05/8-1.jpg" class="card-img-top" alt="Москва - Краснодар">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Краснодар</h5>
                                <p class="card-text">От 4 200 ₽</p>
                                <p class="text-muted small">В пути от 2ч</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://resize.tripster.ru/eZjL9fLGA5RP_y30kWzw_7AlzaM=/fit-in/1080x810/filters:no_upscale()/https://cdn.tripster.ru/photos/b94bdc96-d37d-46e8-b08e-8e9f4f989d26.jpg" class="card-img-top" alt="Москва - Минеральные Воды">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Минеральные Воды</h5>
                                <p class="card-text">От 5 100 ₽</p>
                                <p class="text-muted small">В пути от 2ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65ec5340ca13f70dc5edc8cd_65ec6421dbdab733d52b3cb2/scale_1200" class="card-img-top" alt="Москва - Симферополь">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Симферополь</h5>
                                <p class="card-text">От 5 500 ₽</p>
                                <p class="text-muted small">В пути от 2ч 45м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c9/Old_cathedral_of_Kaliningrad_in_Russia.jpg" class="card-img-top" alt="Москва - Калининград">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Калининград</h5>
                                <p class="card-text">От 4 600 ₽</p>
                                <p class="text-muted small">В пути от 2ч</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Novosibirsk_skyline_in_winter.jpg/960px-Novosibirsk_skyline_in_winter.jpg" class="card-img-top" alt="Москва - Новосибирск">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Новосибирск</h5>
                                <p class="card-text">От 6 200 ₽</p>
                                <p class="text-muted small">В пути от 4ч</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .city-autocomplete {
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

    .city-name {
        font-weight: 600;
        color: #333;
    }

    .city-country {
        font-size: 0.85em;
        color: #666;
        margin-left: 8px;
    }

    .city-airport {
        font-size: 0.8em;
        color: #888;
        display: block;
    }

    .autocomplete-item.active {
        background-color: #e3f2fd;
    }

    .flight-results {
        animation: fadeIn 0.5s ease-in;
    }

    .flight-card {
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

        .flight-card:hover {
            background-color: #f8f9fa;
            border-left-color: #007bff;
            transform: translateX(5px);
        }

    .flight-duration {
        position: relative;
        padding: 10px 0;
    }

        .flight-duration:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #dee2e6 50%, transparent 50%);
            background-size: 10px 2px;
            z-index: 1;
        }

        .flight-duration i {
            position: relative;
            z-index: 2;
            background: white;
            padding: 0 15px;
            color: #007bff;
        }

    .price-block {
        padding: 10px;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
</style>

<script>
        // Обработка отправки формы
    document.getElementById('flightSearchForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const departure = document.getElementById('departureCity').value;
        const arrival = document.getElementById('arrivalCity').value;
        const departureDate = document.getElementById('departureDate').value;
        const returnDate = document.getElementById('returnDate').value;
        const passengers = document.getElementById('passengers').value;

        if (!departure || !arrival) {
            showAlert('Пожалуйста, заполните города вылета и прилета', 'warning');
            return;
        }

        if (!departureDate) {
            showAlert('Пожалуйста, выберите дату вылета', 'warning');
            return;
        }

        // Показываем индикатор загрузки
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Поиск...';
        submitBtn.disabled = true;

        try {
            const searchData = {
                departureCity: extractCityName(departure),
                arrivalCity: extractCityName(arrival),
                departureDate: departureDate,
                returnDate: returnDate || null,
                passengers: parseInt(passengers),
                tripType: returnDate ? "round" : "oneway",
                class: "economy"
            };

            console.log('Отправка запроса:', searchData);

            const response = await fetch('/api/flights/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(searchData)
            });

            const result = await response.json();

            if (result.success) {
                showFlightResults(result.flights);
            } else {
                showAlert(result.error || 'Произошла ошибка при поиске', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showAlert('Ошибка соединения с сервером', 'danger');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // Функция для извлечения названия города из строки автозаполнения
    function extractCityName(fullString) {
        // Убираем код аэропорта и оставляем только название города
        return fullString.split('(')[0].trim();
    }

    // Функция показа результатов
    function showFlightResults(flights) {
        // Удаляем старые результаты
        const oldResults = document.querySelector('.flight-results');
        if (oldResults) oldResults.remove();

        const resultsContainer = document.createElement('div');
        resultsContainer.className = 'flight-results mt-4';

        if (!flights || flights.length === 0) {
            resultsContainer.innerHTML = `
                <div class="alert alert-info">
                    <h5>Рейсы не найдены</h5>
                    <p>Попробуйте изменить параметры поиска или даты</p>
                </div>
            `;
        } else {
            let html = `
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-plane me-2"></i>Найдено рейсов: ${flights.length}</h5>
                    </div>
                    <div class="card-body p-0">
            `;

            flights.forEach(flight => {
                const departureTime = new Date(flight.departureTime).toLocaleTimeString('ru-RU', {
                    hour: '2-digit', minute: '2-digit'
                });
                const arrivalTime = new Date(flight.arrivalTime).toLocaleTimeString('ru-RU', {
                    hour: '2-digit', minute: '2-digit'
                });
                const durationHours = Math.floor(flight.duration / 60);
                const durationMinutes = flight.duration % 60;
                const durationText = `${durationHours}ч ${durationMinutes}м`;

                html += `
                    <div class="flight-card border-bottom p-4">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <h6 class="mb-1">${flight.airline || 'Авиакомпания'}</h6>
                                <small class="text-muted">${flight.flightNumber || ''}</small>
                            </div>
                            <div class="col-md-5">
                                <div class="row align-items-center">
                                    <div class="col-4 text-end">
                                        <div class="fw-bold fs-5">${departureTime}</div>
                                        <small class="text-muted">${flight.departureAirport}</small>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="flight-duration">
                                            <i class="fas fa-plane text-muted"></i>
                                            <div class="small text-muted mt-1">${durationText}</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold fs-5">${arrivalTime}</div>
                                        <small class="text-muted">${flight.arrivalAirport}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge ${flight.transfers === 0 ? 'bg-success' : 'bg-warning'}">
                                    ${flight.transfers === 0 ? 'Прямой' : flight.transfers + ' пересадка'}
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="price-block">
                                    <h4 class="text-primary mb-1">${flight.price.toLocaleString('ru-RU')} ₽</h4>
                                    <button class="btn btn-primary btn-sm">Выбрать</button>
                                </div>
                            </div>
                        </div>
                        ${flight.transfers > 0 ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    ${flight.transfers} пересадка(и)
                                </small>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div></div>';
            resultsContainer.innerHTML = html;
        }

        // Вставляем результаты после формы
        const formCard = document.querySelector('.card.shadow-sm');
        formCard.parentNode.insertBefore(resultsContainer, formCard.nextSibling);
    }

    // Функция показа уведомлений
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);

        // Автоматическое скрытие через 5 секунд
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
