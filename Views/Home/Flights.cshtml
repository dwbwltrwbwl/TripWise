@{
    ViewData["Title"] = "Авиабилеты";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4" style="font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 2.5rem; color: #333; color: #0379D9;">
                Поиск авиабилетов
            </h1>
            <p class="lead">Найдите лучшие предложения на авиабилеты по всему миру</p>

            <!-- Форма поиска авиабилетов -->
            <div class="card shadow-sm border-0" style="margin-top: 0;">
                <div class="card-body p-4">
                    <form id="flightSearchForm">
                        <!-- Первая строка -->
                        <div class="row g-3 align-items-end mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Откуда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-plane-departure"></i></span>
                                    <input type="text"
                                           class="form-control city-autocomplete"
                                           id="departureCity"
                                           placeholder="Город вылета"
                                           autocomplete="off"
                                           style="font-family: 'Nunito', sans-serif;">
                                    <div class="autocomplete-dropdown" id="departureDropdown"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Куда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-plane-arrival"></i></span>
                                    <input type="text"
                                           class="form-control city-autocomplete"
                                           id="arrivalCity"
                                           placeholder="Город прилета"
                                           autocomplete="off"
                                           style="font-family: 'Nunito', sans-serif;">
                                    <div class="autocomplete-dropdown" id="arrivalDropdown"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Вторая строка -->
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Туда</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="departureDate" style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Обратно</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="returnDate" style="font-family: 'Nunito', sans-serif;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-medium" style="font-family: 'Nunito', sans-serif;">Пассажиры</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" id="passengers" style="font-family: 'Nunito', sans-serif;">
                                        <option value="1">1 пассажир</option>
                                        <option value="2">2 пассажира</option>
                                        <option value="3">3 пассажира</option>
                                        <option value="4">4 пассажира</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100 text-center" style="font-family: 'Nunito', sans-serif; height: 46px;">
                                    <i class="fas fa-search me-2"></i>Найти
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Популярные направления -->
            <div class="mt-5">
                <h3 class="mb-4">Популярные направления</h3>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://i.pinimg.com/originals/8e/d6/12/8ed6120ddbb569d44c6c7edaea15cce9.png" class="card-img-top" alt="Москва - Санкт-Петербург">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Санкт-Петербург</h5>
                                <p class="card-text">От 2 500 ₽</p>
                                <p class="text-muted small">В пути от 1ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://www.kupibilet.ru/blog/wp-content/uploads/2025/06/sochi-park-1.jpg" class="card-img-top" alt="Москва - Сочи">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Сочи</h5>
                                <p class="card-text">От 4 800 ₽</p>
                                <p class="text-muted small">В пути от 2ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://cdn.culture.ru/images/a95b2c46-77db-5224-a88b-1079b9f3c3b0" class="card-img-top" alt="Москва - Казань">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Казань</h5>
                                <p class="card-text">От 3 200 ₽</p>
                                <p class="text-muted small">В пути от 1ч 45м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://sdelanounas.ru/i/a/w/1/f_aW1nLmdlbGlvcGhvdG8uY29tL2VrYjIwMjAvMjhfZWtiMjAyMC5qcGc_X19pZD0xMzY3NTQ=.jpeg" class="card-img-top" alt="Москва - Екатеринбург">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Екатеринбург</h5>
                                <p class="card-text">От 3 800 ₽</p>
                                <p class="text-muted small">В пути от 2ч 15м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://blog.ostrovok.ru/wp-content/uploads/2022/05/8-1.jpg" class="card-img-top" alt="Москва - Краснодар">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Краснодар</h5>
                                <p class="card-text">От 4 200 ₽</p>
                                <p class="text-muted small">В пути от 2ч</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://resize.tripster.ru/eZjL9fLGA5RP_y30kWzw_7AlzaM=/fit-in/1080x810/filters:no_upscale()/https://cdn.tripster.ru/photos/b94bdc96-d37d-46e8-b08e-8e9f4f989d26.jpg" class="card-img-top" alt="Москва - Минеральные Воды">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Минеральные Воды</h5>
                                <p class="card-text">От 5 100 ₽</p>
                                <p class="text-muted small">В пути от 2ч 30м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://avatars.dzeninfra.ru/get-zen_doc/271828/pub_65ec5340ca13f70dc5edc8cd_65ec6421dbdab733d52b3cb2/scale_1200" class="card-img-top" alt="Москва - Симферополь">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Симферополь</h5>
                                <p class="card-text">От 5 500 ₽</p>
                                <p class="text-muted small">В пути от 2ч 45м</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/c/c9/Old_cathedral_of_Kaliningrad_in_Russia.jpg" class="card-img-top" alt="Москва - Калининград">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Калининград</h5>
                                <p class="card-text">От 4 600 ₽</p>
                                <p class="text-muted small">В пути от 2ч</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card destination-card h-100">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Novosibirsk_skyline_in_winter.jpg/960px-Novosibirsk_skyline_in_winter.jpg" class="card-img-top" alt="Москва - Новосибирск">
                            <div class="card-body">
                                <h5 class="card-title">Москва → Новосибирск</h5>
                                <p class="card-text">От 6 200 ₽</p>
                                <p class="text-muted small">В пути от 4ч</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .city-autocomplete {
        position: relative;
    }

    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .autocomplete-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

        .autocomplete-item:hover {
            background-color: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

    .city-name {
        font-weight: 600;
        color: #333;
    }

    .city-country {
        font-size: 0.85em;
        color: #666;
        margin-left: 8px;
    }

    .city-airport {
        font-size: 0.8em;
        color: #888;
        display: block;
    }

    .autocomplete-item.active {
        background-color: #e3f2fd;
    }
</style>

<script>
    let currentDropdown = null;
    let currentInput = null;
    let timeoutId;

    // Функция для поиска городов через TravelPayouts API
    async function searchCitiesFromTravelPayouts(query, dropdown) {
        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }

        try {
            // TravelPayouts API для автозаполнения
            const url = `https://autocomplete.travelpayouts.com/places2?term=${encodeURIComponent(query)}&locale=ru&types[]=airport&types[]=city`;

            const response = await fetch(url);
            const data = await response.json();

            // Преобразуем данные в нужный формат
            const cities = data.map(item => {
                let cityName, airportName, country, code;

                if (item.type === 'airport') {
                    cityName = item.city_name || item.name;
                    airportName = item.name;
                    country = item.country_name || item.country_code;
                    code = item.code;
                } else {
                    cityName = item.name;
                    airportName = '';
                    country = item.country_name || item.country_code;
                    code = item.code;
                }

                return {
                    name: cityName,
                    country: country,
                    airport: airportName,
                    code: code,
                    type: item.type
                };
            });

            showAutocompleteResults(cities, dropdown, query);

        } catch (error) {
            console.error('Ошибка при поиске городов:', error);
            dropdown.style.display = 'none';

            // Fallback - показываем сообщение об ошибке
            dropdown.innerHTML = '<div class="autocomplete-item">Ошибка загрузки данных</div>';
            dropdown.style.display = 'block';
        }
    }

    // Функция показа результатов автозаполнения
    function showAutocompleteResults(cities, dropdown, query) {
        dropdown.innerHTML = '';

        if (cities.length === 0) {
            const noResults = document.createElement('div');
            noResults.className = 'autocomplete-item';
            noResults.textContent = 'Ничего не найдено';
            dropdown.appendChild(noResults);
            dropdown.style.display = 'block';
            return;
        }

        // Ограничиваем количество результатов
        const limitedCities = cities.slice(0, 8);

        limitedCities.forEach(city => {
            const item = document.createElement('div');
            item.className = 'autocomplete-item';

            let displayText = '';
            if (city.type === 'airport') {
                displayText = `
                    <div class="city-name">${highlightMatch(city.name, query)}
                        <span class="city-country">${city.country}</span>
                    </div>
                    <div class="city-airport">${city.airport} (${city.code})</div>
                `;
            } else {
                displayText = `
                    <div class="city-name">${highlightMatch(city.name, query)}
                        <span class="city-country">${city.country}</span>
                    </div>
                    <div class="city-airport">Город</div>
                `;
            }

            item.innerHTML = displayText;

            item.addEventListener('click', () => {
                let displayValue;
                if (city.type === 'airport') {
                    displayValue = `${city.name} - ${city.airport} (${city.code})`;
                } else {
                    displayValue = `${city.name} (${city.code})`;
                }
                currentInput.value = displayValue;
                dropdown.style.display = 'none';
            });

            dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';
    }

    // Функция подсветки совпадений
    function highlightMatch(text, query) {
        if (!text) return '';
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<strong>$1</strong>');
    }

    // Debounce для оптимизации запросов
    function debounceSearch(input, dropdown, delay = 300) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            searchCitiesFromTravelPayouts(input.value, dropdown);
        }, delay);
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const departureInput = document.getElementById('departureCity');
        const arrivalInput = document.getElementById('arrivalCity');
        const departureDropdown = document.getElementById('departureDropdown');
        const arrivalDropdown = document.getElementById('arrivalDropdown');

        // Обработчики для поля "Откуда"
        departureInput.addEventListener('input', () => {
            currentDropdown = departureDropdown;
            currentInput = departureInput;
            debounceSearch(departureInput, departureDropdown);
        });

        departureInput.addEventListener('focus', () => {
            if (departureInput.value.length >= 2) {
                currentDropdown = departureDropdown;
                currentInput = departureInput;
                searchCitiesFromTravelPayouts(departureInput.value, departureDropdown);
            }
        });

        // Обработчики для поля "Куда"
        arrivalInput.addEventListener('input', () => {
            currentDropdown = arrivalDropdown;
            currentInput = arrivalInput;
            debounceSearch(arrivalInput, arrivalDropdown);
        });

        arrivalInput.addEventListener('focus', () => {
            if (arrivalInput.value.length >= 2) {
                currentDropdown = arrivalDropdown;
                currentInput = arrivalInput;
                searchCitiesFromTravelPayouts(arrivalInput.value, arrivalDropdown);
            }
        });

        // Закрытие dropdown при клике вне
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.city-autocomplete')) {
                departureDropdown.style.display = 'none';
                arrivalDropdown.style.display = 'none';
            }
        });

        // Навигация с клавиатуры
        document.addEventListener('keydown', (e) => {
            if (!currentDropdown || currentDropdown.style.display === 'none') return;

            const items = currentDropdown.querySelectorAll('.autocomplete-item');
            let activeItem = currentDropdown.querySelector('.autocomplete-item.active');
            let activeIndex = activeItem ? Array.from(items).indexOf(activeItem) : -1;

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (activeIndex < items.length - 1) {
                        if (activeItem) activeItem.classList.remove('active');
                        items[activeIndex + 1].classList.add('active');
                    } else if (items.length > 0 && activeIndex === -1) {
                        items[0].classList.add('active');
                    }
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    if (activeIndex > 0) {
                        if (activeItem) activeItem.classList.remove('active');
                        items[activeIndex - 1].classList.add('active');
                    }
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (activeItem) {
                        activeItem.click();
                    }
                    break;
                case 'Escape':
                    currentDropdown.style.display = 'none';
                    break;
            }
        });

        // Обработка отправки формы
        document.getElementById('flightSearchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const departure = departureInput.value;
            const arrival = arrivalInput.value;
            const departureDate = document.getElementById('departureDate').value;
            const returnDate = document.getElementById('returnDate').value;
            const passengers = document.getElementById('passengers').value;

            if (!departure || !arrival) {
                alert('Пожалуйста, заполните города вылета и прилета');
                return;
            }

            // Здесь можно добавить логику поиска билетов
            console.log('Поиск билетов:', {
                departure,
                arrival,
                departureDate,
                returnDate,
                passengers
            });

            alert(`Поиск билетов из ${departure} в ${arrival} на ${passengers} пассажира(ов)`);
        });

        // Установка минимальной даты (сегодня)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('departureDate').min = today;
        document.getElementById('returnDate').min = today;

        // Обновление минимальной даты для обратного билета
        document.getElementById('departureDate').addEventListener('change', function() {
            document.getElementById('returnDate').min = this.value;
        });
    });
</script>